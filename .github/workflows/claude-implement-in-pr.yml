name: Claude - Implement in PR (milestones)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  implement_in_pr:
    runs-on: ubuntu-latest

    concurrency:
      group: claude-implement-pr-${{ github.event.issue.number }}
      cancel-in-progress: true

    # Only run on PR comments, only when /implement-claude is posted, only by trusted roles.
    if: |
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '/implement-claude') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Implement with milestone commits
        id: claude
        continue-on-error: true
        uses: anthropics/claude-code-action@01e756b34ef7a1447e9508f674143b07d20c2631
        with:
          show_full_output: true
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true

          # IMPORTANT: no '#' comment lines inside this block
          claude_args: |
            --max-turns 80
            --allowedTools Edit
            --allowedTools MultiEdit
            --allowedTools Read
            --allowedTools Write
            --allowedTools LS
            --allowedTools Glob
            --allowedTools Grep
            --allowedTools "Bash(mkdir -p *)"
            --allowedTools "Bash(node *)"
            --allowedTools "Bash(npx run *)"
            --allowedTools "Bash(npx run vitest *)"
            --allowedTools "Bash(npx vitest *)"
            --allowedTools "Bash(npx vitest run *)"
            --allowedTools "Bash(npm --version)"
            --allowedTools "Bash(npm ci*)"
            --allowedTools "Bash(npm test*)"
            --allowedTools "Bash(npm install*)"
            --allowedTools "Bash(npm run lint*)"
            --allowedTools "Bash(npm run typecheck*)"
            --allowedTools "Bash(npm run build*)"
            --allowedTools "Bash(gh api *)"
            --allowedTools "Bash(gh issue view *)"
            --allowedTools "Bash(git add *)"
            --allowedTools "Bash(git commit *)"
            --allowedTools "Bash(git push *)"
            --allowedTools "Bash(git status *)"
            --allowedTools "Bash(git diff *)"
            --allowedTools "Bash(git log *)"
            --allowedTools "Bash(git rm *)"
            --allowedTools "Bash(git reset *)"

          prompt: |
            You are implementing work on the CURRENT PR branch.

            First, locate the approved plan to implement:
            - Determine the linked issue number (the PR body contains "Fixes #<N>").
            - Fetch the issue and its comments using GitHub CLI.
            - Find the MOST RECENT comment authored by claude[bot] that looks like an implementation plan.
              Use heuristics: it usually contains headings like "Implementation Plan", "Summary of Approach",
              "Concrete File Paths", "Checklist", "Risks", or "Tests".
            - Treat that latest plan comment as authoritative. Ignore older plans.

            Resume check (do this before coding):
            - git status
            - git log --oneline -n 20
            - If there are existing commits for this work, continue from current state (do not restart).

            Milestoning rules (adaptive, do not skip):
            - Derive 3–6 checkpoints from the plan’s checklist (group adjacent checklist items into coherent chunks).
            - Post the checkpoint list in a PR comment as a checklist.
            - After completing EACH checkpoint:
              - git status
              - git add -A
              - git commit -m "<checkpoint title>\n\nCo-authored-by: Andrew Johnson <andrewsjohnson@users.noreply.github.com>"
              - git push origin <current-branch>

            Commit triggers (in addition to checkpoints):
            - If you changed 8+ files since the last commit, commit + push.
            - If you completed any runnable verification (typecheck/lint/tests), commit + push.

            Verification:
            - Run the repo checks defined in CLAUDE.md.
            - Typical commands are: npm ci, npm run typecheck, npm run lint, npm run test:ci (or npm test).

            Rules:
            - Avoid shell pipelines/redirection (no &&, ||, 2>&1).
            - Keep commits small and clean.
            - Never end the run with uncommitted changes.
            - If you are close to max turns, stop after pushing a commit (WIP ok) and leave a PR comment:
              - what’s done
              - what’s next
              - any blockers / missing permissions / failing commands

      - name: Fail workflow if Claude step failed unexpectedly
        if: steps.claude.outcome == 'failure'
        run: |
          echo "Claude implement step failed. Check the job output for details."
          exit 1
