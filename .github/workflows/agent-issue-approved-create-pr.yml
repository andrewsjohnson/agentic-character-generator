name: Agent - Create PR From Approved Issue

on:
  issue_comment:
    types: [created]

jobs:
  create_pr:
    if: >
      github.event.issue.pull_request == null &&
      startsWith(github.event.comment.body, '/agent-approve')
    runs-on: ubuntu-latest
    permissions:
      contents: read

    concurrency:
      group: agent-create-pr-issue-${{ github.event.issue.number }}
      cancel-in-progress: true

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Export token for gh
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> "$GITHUB_ENV"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git to push as GitHub App
        run: |
          set -euo pipefail
          git config user.name "agentic-automation[bot]"
          git config user.email "agentic-automation[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ github.repository }}.git"

      - name: Ensure branch exists and is usable (idempotent + kickoff commit)
        id: ensure_branch
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"

          TITLE="$(gh issue view "$ISSUE_NUMBER" --repo "$REPO" --json title -q .title)"
          SAFE_TITLE="$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-' | sed 's/^-//;s/-$//')"
          BRANCH="agent/issue-${ISSUE_NUMBER}-${SAFE_TITLE}"

          BASE_BRANCH="$(gh repo view "$REPO" --json defaultBranchRef -q .defaultBranchRef.name)"

          git fetch origin "$BASE_BRANCH"

          if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
            echo "Remote branch exists: $BRANCH"
            # Force local branch to exactly match remote branch tip
            git fetch origin "$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"
          else
            echo "Remote branch does not exist. Creating $BRANCH from origin/$BASE_BRANCH"
            git checkout -B "$BRANCH" "origin/$BASE_BRANCH"

            # Always create kickoff commit so PR can be created
            git commit --allow-empty -m "chore: initialize PR for issue #${ISSUE_NUMBER}"
            git push -u origin "$BRANCH"
          fi

          # If branch exists but is still not ahead of base, add kickoff commit now.
          # This handles cases where a previous run created the branch but didn’t add a commit.
          git fetch origin "$BASE_BRANCH"
          git fetch origin "$BRANCH"
          git checkout -B "$BRANCH" "origin/$BRANCH"

          AHEAD_BY="$(git rev-list --count "origin/$BASE_BRANCH..$BRANCH")"
          if [ "$AHEAD_BY" -eq 0 ]; then
            echo "Branch has no commits ahead of $BASE_BRANCH; adding kickoff commit."
            git commit --allow-empty -m "chore: initialize PR for issue #${ISSUE_NUMBER}"
            git push origin "$BRANCH"
          else
            echo "Branch is ahead of $BASE_BRANCH by $AHEAD_BY commits (local compare)."
          fi

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "base_branch=$BASE_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create or reuse PR (idempotent)
        id: create_pr
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ steps.ensure_branch.outputs.branch }}"
          BASE_BRANCH="${{ steps.ensure_branch.outputs.base_branch }}"

          # Reuse existing open PR if present
          EXISTING_PR_NUMBER="$(
            gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number -q '.[0].number // ""'
          )"

          if [ -n "$EXISTING_PR_NUMBER" ]; then
            PR_NUMBER="$EXISTING_PR_NUMBER"
            PR_URL="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json url -q .url)"
            PR_CREATED="no"
          else
            TITLE="$(gh issue view "$ISSUE_NUMBER" --repo "$REPO" --json title -q .title)"

            PLAN="$(gh issue view "$ISSUE_NUMBER" --repo "$REPO" --json comments \
              -q '.comments | map(select(.body | test("^## Plan v[0-9]+"))) | last | .body // ""')"
            if [ -z "$PLAN" ]; then
              PLAN="$(gh issue view "$ISSUE_NUMBER" --repo "$REPO" --json body -q .body)"
            fi

            BODY="$(printf "Implements: #%s\n\n%s\n" "$ISSUE_NUMBER" "$PLAN")"

            PR_URL="$(gh pr create --repo "$REPO" \
              --title "$TITLE" \
              --body "$BODY" \
              --base "$BASE_BRANCH" \
              --head "$BRANCH")"

            PR_NUMBER="$(gh pr view "$PR_URL" --repo "$REPO" --json number -q .number)"
            PR_CREATED="yes"
          fi

          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "pr_created=$PR_CREATED" >> "$GITHUB_OUTPUT"

      - name: Trigger implementation on PR
        run: |
          set -euo pipefail
          gh pr comment "${{ steps.create_pr.outputs.pr_number }}" --repo "${{ github.repository }}" --body "/agent-implement"

      - name: Comment on issue with PR link
        run: |
          set -euo pipefail
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"

          PR_URL="${{ steps.create_pr.outputs.pr_url }}"
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number }}"
          PR_CREATED="${{ steps.create_pr.outputs.pr_created }}"

          if [ "$PR_CREATED" = "yes" ]; then
            MESSAGE="✅ Created PR #${PR_NUMBER}: ${PR_URL}"
          else
            MESSAGE="ℹ️ Reusing existing PR #${PR_NUMBER}: ${PR_URL}"
          fi

          gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "$MESSAGE"

