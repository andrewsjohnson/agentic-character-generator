name: Agent - Plan Revise Command (Issue)

on:
  issue_comment:
    types: [created]

jobs:
  request_revision:
    if: >
      github.event.issue.pull_request == null &&
      startsWith(github.event.comment.body, '/plan-revise')
    runs-on: ubuntu-latest

    # Use GitHub App token via GH_TOKEN; keep default perms minimal.
    permissions:
      contents: read

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Export token for gh
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> "$GITHUB_ENV"

      - name: Add NEEDS-PLAN-REVISION label (idempotent)
        run: |
          set -euo pipefail
          gh issue edit ${{ github.event.issue.number }} --repo ${{ github.repository }} \
            --add-label "NEEDS-PLAN-REVISION"
