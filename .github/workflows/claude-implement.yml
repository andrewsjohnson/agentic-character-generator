name: Claude - Implement + PR

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  implement:
    runs-on: ubuntu-latest

    # Only on issues (not PRs), only when /approve-claude is posted,
    # only by trusted roles.
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/approve-claude') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')

    steps:
      - uses: actions/checkout@v4

      - name: Implement the approved plan
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            Implement the plan found between:
            <!-- CLAUDE_PLAN_START --> and <!-- CLAUDE_PLAN_END -->
            in the issue comments.

            Requirements:
            - Create a new branch (Claude will do this automatically for issues).
            - Implement the changes.
            - Add/update tests as described.
            - Run the repoâ€™s standard checks (from CLAUDE.md if present).
            - Ensure commits are clean and scoped.

            When done, summarize what changed and any follow-ups in a final issue comment.

      - name: Create PR (idempotent)
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH: ${{ steps.claude.outputs.branch_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "Claude branch: $BRANCH"

          # If a PR already exists for this head branch, do nothing
          existing_pr=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number // empty')
          if [ -n "$existing_pr" ]; then
            echo "PR already exists: #$existing_pr"
            exit 0
          fi

          title="(Claude) ${ISSUE_NUMBER}: ${GITHUB_EVENT_ISSUE_TITLE:-Implementation}"
          body=$(cat <<EOF
          Fixes #$ISSUE_NUMBER

          Generated by Claude Code.

          - Please review the PR description + commits.
          - You can request incremental changes by commenting on the PR with @claude.
          EOF
          )

          gh pr create \
            --repo "$REPO" \
            --head "$BRANCH" \
            --base "${{ github.event.repository.default_branch }}" \
            --title "$title" \
            --body "$body"
