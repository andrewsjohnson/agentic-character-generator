name: Agent - Review PR

on:
  issue_comment:
    types: [created]

concurrency:
  group: review-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  review:
    # Fork protection: only run on same-repo branches for /agent-review commands.
    if: >
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/agent-review')
    runs-on: ubuntu-latest

    # Keep default token minimal; use GitHub App token for gh edits.
    permissions:
      contents: read

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Export token for gh
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> "$GITHUB_ENV"


      - name: Fork guard (same-repo branches only)
        run: |
          set -euo pipefail
          PR="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"
          HEAD_FULL_NAME="$(gh pr view "$PR" --repo "$REPO" --json headRepository -q '.headRepository.full_name // ""')"
          if [ "$HEAD_FULL_NAME" != "$REPO" ]; then
            echo "PR is from a fork ($HEAD_FULL_NAME); skipping automation."
            exit 0
          fi

      - name: Guardrails (skip if halted / awaiting feedback)
        run: |
          set -euo pipefail
          PR="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"
          LABELS="$(gh pr view "$PR" --repo "$REPO" --json labels -q '.labels[].name')"

          if echo "$LABELS" | grep -qx 'HALTED'; then
            echo "HALTED set; exiting."
            exit 0
          fi

          if echo "$LABELS" | grep -qx 'AWAITING-FEEDBACK'; then
            echo "AWAITING-FEEDBACK set; exiting."
            exit 0
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR branch
        run: gh pr checkout ${{ github.event.issue.number }} --repo ${{ github.repository }}

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          allowed_bots: agentic-automation-app[bot]
          claude_args: |
            --model opus
            --max-turns 45
            --settings ./claude/agents/reviewer.json
          prompt: |
            You are the REVIEW agent.

            ROLE
            Senior Code Reviewer focused on correctness, readability, testability, regression risk, and repo conventions.

            SOURCE OF TRUTH
            - The PR body contains the authoritative implementation plan. Review against it.
            - The repository code is available for context.
            - You may consult the linked issue for additional context, but do not override the PR-body plan.

            REVIEW OBJECTIVES

            1) Intent & Scope
            - Summarize intended change based on the PR-body plan.
            - Confirm the implementation aligns with the plan.
            - Flag scope creep or missing plan items.

            2) Correctness & Risk
            - Check regression risk.
            - Pay special attention to:
              - async/concurrency hazards
              - input validation
              - error handling and boundaries
              - null/undefined edge cases
              - resource cleanup
            - Identify potential silent failures.

            3) Architecture & Conventions
            - Enforce repo rules from CLAUDE.md (layering, DI, logging, patterns).
            - Check dependency direction and boundaries.
            - Flag inconsistencies in logging/observability/error reporting.

            4) Test Quality
            - Verify tests cover:
              - happy path
              - at least one meaningful failure/edge path
            - Flag brittle mocks or overly implementation-coupled tests.
            - Ensure new logic is tested where appropriate.

            5) Maintainability
            - Naming clarity, complexity, large functions, dead code, missing comments for non-obvious logic.

            FOLLOW-UP CANDIDATES (post-merge)
            - If your verdict is APPROVE and you found truly minor/low-risk items that should not block merge,
              include a section exactly titled:

              ### Follow-up candidates (post-merge)
              - [ ] <Title> â€” <1-2 sentence rationale>. Paths: <path1>, <path2>

            Rules for follow-ups:
            - Do NOT include subjective style nits.
            - Only include small, clearly actionable improvements (small refactor, small test gap, doc tweak, cleanup).
            - Include 1-3 items max. If there are more, include ONE item titled "Follow-ups" with a checklist in the description.
            - If there are no follow-ups, omit the section entirely.

            OUTPUT FORMAT (single PR comment)

            Start with:

            ## Review

            ### Executive Summary
            - 3-6 sentence summary of overall quality and risk level.

            ### Findings
            Provide a table with columns:
            {file, line (if known), severity [info|minor|major|critical], category, issue, suggested fix}

            If changes are required:
            - Add a section:

            ### Required fixes
            - Bullet list of concrete required changes.

            End with EXACTLY ONE of:

            Verdict: APPROVE
            or
            Verdict: CHANGES_REQUESTED

      - name: Apply labels based on verdict
        run: |
          set -euo pipefail
          PR="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"

          # Look at the latest claude[bot] comment that contains "Verdict:"
          VERDICT="$(gh pr view "$PR" --repo "$REPO" --json comments \
            -q '.comments | map(select(.author.login == "claude[bot]")) | map(select(.body | test("Verdict:"))) | last | .body // ""' \
            | sed -n 's/.*Verdict: *//p' | tail -n 1 | tr -d '\r' | tr '[:lower:]' '[:upper:]')"

          echo "Verdict parsed: ${VERDICT:-<none>}"

          if [ "$VERDICT" = "APPROVE" ] || [ "$VERDICT" = "APPROVED" ]; then
            echo "Review approved; no follow-up automation required."
            exit 0
          fi

          if [ "$VERDICT" = "CHANGES_REQUESTED" ]; then
            gh api repos/"$REPO"/dispatches \
              --method POST \
              --field event_type="agent-implement" \
              --field client_payload[pr_number]="$PR"
            exit 0
          fi

          echo "No recognized verdict; leaving labels as-is."
