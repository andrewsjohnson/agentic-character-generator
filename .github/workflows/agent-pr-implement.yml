name: Agent - Implement PR

on:
  issue_comment:
    types: [created]

concurrency:
  group: implement-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  implement:
    if: >
      (github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/agent-implement'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PR_NUMBER: ${{ github.event.issue.number }}

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Export token for gh
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> "$GITHUB_ENV"


      - name: Fork guard (same-repo branches only)
        run: |
          set -euo pipefail
          PR="$PR_NUMBER"
          REPO="${{ github.repository }}"
          HEAD_FULL_NAME="$(gh pr view "$PR" --repo "$REPO" --json headRepository -q '.headRepository.full_name // ""')"
          if [ "$HEAD_FULL_NAME" != "$REPO" ]; then
            echo "PR is from a fork ($HEAD_FULL_NAME); skipping automation."
            exit 0
          fi

      - name: Guardrails (skip if halted/awaiting feedback)
        run: |
          set -euo pipefail
          PR="$PR_NUMBER"
          REPO="${{ github.repository }}"
          LABELS="$(gh pr view "$PR" --repo "$REPO" --json labels -q '.labels[].name')"
      
          if echo "$LABELS" | grep -qx 'HALTED'; then
            echo "HALTED set; exiting."
            exit 0
          fi
      
          if echo "$LABELS" | grep -qx 'AWAITING-FEEDBACK'; then
            echo "Awaiting feedback; exiting."
            exit 0
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true

      - name: Checkout PR branch
        run: gh pr checkout "$PR_NUMBER" --repo ${{ github.repository }}

      - name: Configure git identity
        run: |
          git config user.name "agentic-automation[bot]"
          git config user.email "agentic-automation[bot]@users.noreply.github.com"

      - name: Parse model from trigger comment
        id: model
        run: |
          set -euo pipefail
          WORD2=$(echo "${{ github.event.comment.body }}" | awk 'NR==1{print $2}')
          if echo "$WORD2" | grep -qE '^(opus|sonnet|haiku)$'; then
            echo "value=$WORD2" >> "$GITHUB_OUTPUT"
          else
            echo "value=opus" >> "$GITHUB_OUTPUT"
          fi

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          allowed_bots: agentic-automation-app[bot]
          track_progress: true
          show_full_output: true
          claude_args: |
            --model ${{ steps.model.outputs.value }}
            --max-turns 120
            --settings ./claude/agents/implementer.json
          prompt: |
            You are the IMPLEMENTATION agent working on the CURRENT PR branch.

            IMPORTANT WORKFLOW REQUIREMENT
            - Use interactive PR commenting style (progress updates + final implementation summary comment).
            - Post final outputs as normal PR comments (do not overwrite prior comments).

            PRIMARY GOAL
            - Implement the plan contained in the PR body with high reliability and continuity across runs.
            - You MUST commit and push progress frequently so another run can continue from where it left off.

            0) Locate the authoritative plan (do this first)
            - The PR body contains the authoritative implementation plan. Use it as the single source of truth.
            - The PR body also includes a reference like "Closes #<N>". You may open the linked issue for extra context,
              but do not replace or override the PR-body plan with issue comments.

            1) Resume check (before coding)
            - Run:
              - git status
              - git log --oneline -n 20
            - If there are existing commits for this work, CONTINUE from the current state; do not restart.

            2) Milestoning rules (adaptive; do not skip)
            - Derive 3-6 checkpoints from the PR-body plan's checklist/steps by grouping adjacent items into coherent chunks.
            - Post a PR comment containing:
              - "## Implementation checkpoints"
              - a markdown checklist of the checkpoints
              - a short "Starting state" note (what seems already done, if anything)

            3) Implementation process
            - Work checkpoint-by-checkpoint.
            - Keep changes minimal and aligned with the PR-body plan.

            4) Commit + push discipline (VERY IMPORTANT)
            You must NEVER end the run with uncommitted changes.

            After completing EACH checkpoint:
            - git status
            - git add -A
            - git commit -m "<checkpoint title>

            Co-authored-by: Andrew Johnson <andrewsjohnson@users.noreply.github.com>"
            - git push origin <current-branch>

            Additional commit triggers (commit + push immediately when any occurs):
            - You have modified 8+ files since the last commit.
            - You completed any runnable verification (typecheck/lint/tests/build).
            - You suspect you might be approaching max turns: STOP, COMMIT+PUSH (WIP acceptable), then leave a handoff comment.

            5) Verification
            - Prefer the repo's canonical commands (CLAUDE.md if present).
            - Typical checks for this repo:
              - npm ci (or npm install if no lockfile)
              - npm run typecheck
              - npm run lint
              - npx vitest run
              - npm run build

            6) Human decisions / clarifying questions
            If you need a human decision:
            - Post a PR comment titled "## Questions for human" with numbered questions and 2-3 options each.
            - Add label: AWAITING-FEEDBACK
            - Commit and push any safe progress already made, ensure working tree is clean, then stop.

            When the human replies (comment begins with /agent), you will resume and continue from the current branch state.

            7) Output and handoff
            When complete:
            - Ensure everything is committed and pushed.
            - Post "## Implementation summary" with what changed + how verified.
            - End your final comment with a model recommendation for the review agent:
              <!-- next-model: X -->
              where X is haiku, sonnet, or opus. Base the choice on the complexity of what was implemented:
              - haiku: trivial change (docs, minor copy, single-line fix, config tweak)
              - sonnet: moderate change (typical feature, a few files, standard patterns)
              - opus: complex change (multi-system, high-risk logic, intricate interactions)

            If stopping early:
            - Commit+push (WIP ok), then post "## Handoff" with what's done / next / blockers.
            - Include <!-- next-model: X --> at the end of the handoff comment using the same criteria above.

            8) Shell safety rules
            - Avoid shell pipelines/redirection (no &&, ||, |, >, 2>&1).
            - Run commands as separate steps.

      - name: If Questions for human comment exists (anywhere), ensure AWAITING-FEEDBACK label
        if: success()
        run: |
          set -euo pipefail
          PR="$PR_NUMBER"
          REPO="${{ github.repository }}"

          # Detect if ANY comment contains the header, not just the latest.
          HAS_Q="$(gh pr view "$PR" --repo "$REPO" --json comments \
            -q '.comments | map(.body // "") | any(test("^## Questions for human"; "m"))')"

          if [ "$HAS_Q" = "true" ]; then
            echo "Detected '## Questions for human' in comments; applying AWAITING-FEEDBACK label."
            gh pr edit "$PR" --repo "$REPO" --add-label "AWAITING-FEEDBACK" || true
          else
            echo "No 'Questions for human' marker detected."
          fi

      - name: On success - if awaiting feedback, stop here (do not trigger review)
        if: success()
        run: |
          set -euo pipefail
          PR="$PR_NUMBER"
          REPO="${{ github.repository }}"
          LABELS="$(gh pr view "$PR" --repo "$REPO" --json labels -q '.labels[].name')"

          if echo "$LABELS" | grep -q '^AWAITING-FEEDBACK$'; then
            echo "AWAITING-FEEDBACK present; leaving PR awaiting input."
            exit 0
          fi

      - name: On success -> trigger review
        if: success()
        run: |
          set -euo pipefail
          PR="$PR_NUMBER"
          REPO="${{ github.repository }}"

          NEXT_MODEL="$(gh pr view "$PR" --repo "$REPO" --json comments \
            -q '[.comments[].body | select(contains("<!-- next-model:"))] | last // ""' \
            | grep -oP '(?<=<!-- next-model: )\w+' || true)"
          if ! echo "$NEXT_MODEL" | grep -qE '^(opus|sonnet|haiku)$'; then
            NEXT_MODEL="opus"
          fi

          gh pr comment "$PR" --repo "$REPO" --body "/agent-review $NEXT_MODEL"

      - name: On failure -> retry ladder / halt
        if: failure()
        run: |
          set -euo pipefail
          PR="$PR_NUMBER"
          REPO="${{ github.repository }}"
          LABELS="$(gh pr view "$PR" --repo "$REPO" --json labels -q '.labels[].name')"

          if echo "$LABELS" | grep -q '^AWAITING-FEEDBACK$'; then
            echo "AWAITING-FEEDBACK present on failure; not applying retry ladder."
            exit 0
          fi

          if echo "$LABELS" | grep -q '^RETRY-TWO$'; then
            gh pr edit "$PR" --repo "$REPO" \
              --remove-label "RETRY-ONE" \
              --remove-label "RETRY-TWO" \
              --add-label "HALTED"
            exit 0
          fi

          if echo "$LABELS" | grep -q '^RETRY-ONE$'; then
            gh pr edit "$PR" --repo "$REPO" --add-label "RETRY-TWO"
            gh pr comment "$PR" --repo "$REPO" --body "/agent-implement"
            exit 0
          fi

          gh pr edit "$PR" --repo "$REPO" --add-label "RETRY-ONE"
          gh pr comment "$PR" --repo "$REPO" --body "/agent-implement"
