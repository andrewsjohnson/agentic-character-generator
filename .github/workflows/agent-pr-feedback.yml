name: Agent - PR Feedback Handler

on:
  issue_comment:
    types: [created]

jobs:
  resume:
    # Only trigger for human comments â€” bot-to-bot handoff comments
    # (e.g. /agent-implement posted by the review workflow) are excluded
    # to avoid wasteful no-op runs.
    if: >
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/agent') &&
      !endsWith(github.event.comment.user.login, '[bot]')
    runs-on: ubuntu-latest

    # Use GitHub App token via GH_TOKEN; keep default perms minimal.
    permissions:
      contents: read

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Export token for gh
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> "$GITHUB_ENV"

      - name: If awaiting feedback, re-trigger implementation
        run: |
          set -euo pipefail
          PR="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"

          LABELS="$(gh pr view "$PR" --repo "$REPO" --json labels -q '.labels[].name')"

          echo "$LABELS" | grep -q '^HALTED$' && { echo "HALTED; no-op."; exit 0; }
          echo "$LABELS" | grep -q '^AWAITING-FEEDBACK$' || { echo "Not awaiting feedback; no-op."; exit 0; }

          gh pr edit "$PR" --repo "$REPO" --remove-label "AWAITING-FEEDBACK" || true

          gh pr comment "$PR" --repo "$REPO" --body "/agent-implement"
