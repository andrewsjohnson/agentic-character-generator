name: Claude - Implement + PR

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  implement:
    runs-on: ubuntu-latest

    concurrency:
      group: claude-implement-issue-${{ github.event.issue.number }}
      cancel-in-progress: true

    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/approve-claude') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')

    steps:
      - uses: actions/checkout@v4

      - name: Implement the approved plan
        id: claude
        # Pin due to current @v1 SDK crash
        uses: anthropics/claude-code-action@01e756b34ef7a1447e9508f674143b07d20c2631
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true

          claude_args: |
            --max-turns 12

            # ===== File editing =====
            --allowedTools Edit
            --allowedTools MultiEdit
            --allowedTools Read
            --allowedTools Write
            --allowedTools LS
            --allowedTools Glob
            --allowedTools Grep

            # ===== Node + project commands =====
            --allowedTools "Bash(mkdir -p *)"
            --allowedTools "Bash(node *)"
            --allowedTools "Bash(npm ci*)"
            --allowedTools "Bash(npm test*)"
            --allowedTools "Bash(npm run lint*)"
            --allowedTools "Bash(npm run typecheck*)"
            --allowedTools "Bash(npm run build*)"

            # ===== Git operations =====
            --allowedTools "Bash(git add *)"
            --allowedTools "Bash(git commit *)"
            --allowedTools "Bash(git push *)"
            --allowedTools "Bash(git status *)"
            --allowedTools "Bash(git diff *)"
            --allowedTools "Bash(git log *)"
            --allowedTools "Bash(git rm *)"

          prompt: |
            Implement the plan found between:
            <!-- CLAUDE_PLAN_START --> and <!-- CLAUDE_PLAN_END -->
            in the issue comments.

            Requirements:
            - Create a new branch automatically.
            - Implement the changes.
            - Add/update tests as described.
            - Run repo checks from CLAUDE.md.
            - Avoid shell pipelines (no &&, ||, redirects).
            - Keep commits small and clean.

            When done, summarize changes and follow-ups in an issue comment.

      - name: Create PR (idempotent)
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH: ${{ steps.claude.outputs.branch_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "Claude branch: $BRANCH"

          existing_pr=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number // empty')
          if [ -n "$existing_pr" ]; then
            echo "PR already exists: #$existing_pr"
            exit 0
          fi

          title="(Claude) ${ISSUE_NUMBER}: ${GITHUB_EVENT_ISSUE_TITLE:-Implementation}"
          body=$(cat <<EOF
          Fixes #$ISSUE_NUMBER

          Generated by Claude Code.

          - Request changes with @claude on the PR.
          EOF
          )

          gh pr create \
