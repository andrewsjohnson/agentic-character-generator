name: CI Result Handler

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  clear_ci_failed:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Export token for gh
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> "$GITHUB_ENV"

      - name: Remove CI-FAILED label if present
        run: |
          set -euo pipefail

          PR_NUMBER="$(jq -r '.workflow_run.pull_requests[0].number // empty' "$GITHUB_EVENT_PATH")"
          if [ -z "$PR_NUMBER" ]; then
            echo "No associated PR. Exiting."
            exit 0
          fi

          REPO="${{ github.repository }}"
          gh pr edit "$PR_NUMBER" --repo "$REPO" --remove-label "CI-FAILED" 2>/dev/null || true

  trigger_fix:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest

    # Keep default token minimal; use GitHub App token for gh edits.
    permissions:
      contents: read

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Export token for gh
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> "$GITHUB_ENV"

      - name: Find PR and label it for fixing (unless in-progress/awaiting/halted)
        run: |
          set -euo pipefail

          PR_NUMBER="$(jq -r '.workflow_run.pull_requests[0].number // empty' "$GITHUB_EVENT_PATH")"
          if [ -z "$PR_NUMBER" ]; then
            echo "No associated PR (maybe a push run). Exiting."
            exit 0
          fi

          REPO="${{ github.repository }}"

          # Fork protection: do not automate on forks
          HEAD_FULL_NAME="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json headRepository -q '.headRepository.full_name // ""')"
          if [ "$HEAD_FULL_NAME" != "$REPO" ]; then
            echo "PR is from a fork ($HEAD_FULL_NAME); skipping automation."
            exit 0
          fi

          LABELS="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json labels -q '.labels[].name')"

          echo "$LABELS" | grep -q '^IN-PROGRESS$' && { echo "IN-PROGRESS; skip."; exit 0; }
          echo "$LABELS" | grep -q '^AWAITING-FEEDBACK$' && { echo "AWAITING-FEEDBACK; skip."; exit 0; }
          echo "$LABELS" | grep -q '^HALTED$' && { echo "HALTED; skip."; exit 0; }

          gh pr edit "$PR_NUMBER" --repo "$REPO" --add-label "CI-FAILED" || true

          # Bounce back to implementer for fixes via PR command comment
          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "/agent-implement"
